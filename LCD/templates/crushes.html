{% extends "base.html" %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/stylesheets/jquery/jquery-ui-1.8.12.custom.css" />
<script type="text/javascript" src="/js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.12.custom.min.js"></script>
{% endblock %}

{% block content %}
<div id="main" class="colwrapper">

<div class="leftcol">
    <div id="crushes-header">
    <h2 style="display:inline;">Crushes</h2>
    <span id="new-crush">new crush: <input type="text" class="crush" name="crush"></span>
    </div>
    <div id="crushes">
    {% for crush in crushes %}
    <div class="crushdiv">
        <img src="/user_images/{{ crush.target.carletonID }}.jpg" width="120" height="120" alt="{{ crush.target.carletonID }}"><br>
        {{ crush.target.first_name }} {{ crush.target.last_name }}<br>
        {% if not crush.target.opted_in %}<span style="color:red;">opted out</span><br>
        {% else %}
            {% if not crush.target.googleID %}<span style="color:red;">not yet registered</span><br>
            {% else %}<span style="color:green;">available!</span><br>
            {% endif %}
        {% endif %}
        <button class="messageCrush" value="{{ crush.target.carletonID }}" data-first-name="{{ crush.target.first_name }}" data-last-name="{{ crush.target.last_name }}">message</button>
        <button class="removeCrush" value="{{ crush.target.carletonID }}">remove</button>
    </div>
    {% endfor %}
    </div>
</div>

<div class="rightcol">
    <div id="messages-header">
        <h2 style="display:inline;">Messages</h2>
        <ul id="messages-nav">
            <li id="messages-nav-to-me" class="active"><a href="javascript:void(0);" onclick="javascript:showMessages('to-me');">To Me</a></li>
            <li id="messages-nav-from-me"><a href="javascript:void(0);" onclick="javascript:showMessages('from-me');">From Me</a></li>
        </ul>
    </div>
    <div id="messages-to-me" class="messages-tab">
    <div class="messages">
       {% for message in messages %}
         <div class="message" data-mid="{{ message.key.id }}">
         <div class="message-item">
           <div class="message-item-header">
           <div class="message-item-info"><strong>Crush #{{ message.source.key.id }}</strong> on {{ message.created|date:"M d \@ g:i:s A"}}</div>
           <div class="message-actions">
             <ul class="icons ui-widget ui-helper-clearfix">
               {% if not message.replies.count %}<li class="ui-state-default ui-corner-all reply-button" title="Reply"><span class="ui-icon ui-icon-arrowreturnthick-1-w"></span></li>{% endif %}
               <li class="ui-state-default ui-corner-all delete-button" title="Delete"><span class="ui-icon ui-icon-trash"></span></li>
               <li class="ui-state-default ui-corner-all block-button" title="Block User"><span class="ui-icon ui-icon-cancel"></span></li>
             </ul>
           </div>
           </div>
           <div class="message-item-body">{{ message.body }}</div>
         </div>
         {% for reply in message.replies %}
           <div class="message-item reply{% if carleton_id == reply.source.carletonID %} sent{% endif %}">
             <div class="message-item-header">
             <div class="message-item-info">
               {% if carleton_id == reply.source.carletonID %}<strong>You</strong> on
               {% else %}<strong>Crush #{{ message.source.key.id }}</strong> on {% endif %}
               {{ reply.created|date:"M d \@ g:i:s A"}}
             </div>
             </div>
	         <div class="message-item-body">{{ reply.body }}</div>
	       </div>
	     {% endfor %}
         <div class="message-item reply reply-box"{% if not message.replies.count %} style="display:none;"{% endif %}><input type="text" class="reply-text"></div>
         </div>
       {% endfor %}
    </div>
    </div>
    <div id="messages-from-me" class="messages-tab">
    <div class="messages">
       {% for message in sent_messages %}
         <div class="message" data-mid="{{ message.key.id }}">
         <div class="message-item sent">
           <div class="message-item-header">
           <div class="message-item-info"><strong>You</strong> to <strong>{{ message.target.first_name }} {{ message.target.last_name }}</strong> on {{ message.created|date:"M d \@ g:i:s A"}}</div>
           <div class="message-actions">
             <ul class="icons ui-widget ui-helper-clearfix">
               {% if not message.replies.count %}<li class="ui-state-default ui-corner-all reply-button" title="Reply"><span class="ui-icon ui-icon-arrowreturnthick-1-w"></span></li>{% endif %}
               <li class="ui-state-default ui-corner-all delete-button" title="Delete"><span class="ui-icon ui-icon-trash"></span></li>
               <li class="ui-state-default ui-corner-all block-button" title="Block User"><span class="ui-icon ui-icon-cancel"></span></li>
             </ul>
           </div>
           </div>
           <div class="message-item-body">{{ message.body }}</div>
         </div>
         {% for reply in message.replies %}
           <div class="message-item{% if carleton_id == reply.source.carletonID %} reply sent{% endif %}">
             <div class="message-item-header">
             <div class="message-item-info">
               {% if carleton_id == reply.source.carletonID %}<strong>You</strong> on
               {% else %}<strong>{{ reply.source.first_name }} {{ reply.source.last_name }}</strong> on {% endif %}
               {{ reply.created|date:"M d \@ g:i:s A"}}
             </div>
             </div>
	         <div class="message-item-body">{{ reply.body }}</div>
	       </div>
  	   {% endfor %}
       <div class="message-item reply reply-box"{% if not message.replies.count %} style="display:none;"{% endif %}><input type="text" class="reply-text"></div>
       </div>
       {% endfor %}
    </div>
    </div>
</div>

</div>

<div id="new-message-form" title="New Message">
  <form>
  <fieldset>
    <input type="hidden" name="message-to" id="message-to">
    <label for="message-to-box">To</label><input type="text" name="message-to-box" id="message-to-box" class="text ui-widget-content ui-corner-all" disabled>
    <label for="message-body">Body</label><textarea name="message-body" id="message-body" class="text ui-widget-content ui-corner-all"></textarea>
  </fieldset>
  <p>Note: Beware of what you send. Even though messages are anonymous, users have the power to block you, so don't spam and be appropriate.</p>
</form>
</div>

<script>
$(document).ready(function() {
    $.getJSON('/autofill', function(data) {
        $(".crush").autocomplete({
            minLength: 1,
            delay: 0,
            source: data,
            select: function(event, ui) {
                $(this).val("");
                    $.post("/crushes/add", { "crush": ui.item.carletonID }, function(data) {
                        if (data.success == 0) {
                            var status;
                            if (data.status == "not_paired") { status = '<span style="color:red;">not yet registered</span><br>'; }
                            else if (data.status == "opted_out") { status = '<span style="color:red;">opted out</span><br>'; }
                            else { status = '<span style="color:green;">available!</span><br>'; }
                            $("#crushes").append('<div class="crushdiv"><img src="/user_images/' + ui.item.carletonID + '.jpg" width="120" height="120"><br>' + ui.item.first_name + " " + ui.item.last_name + "<br>" + status + '<button class="messageCrush" value="' + ui.item.carletonID + '">message</button> <button class="removeCrush" value="' + ui.item.carletonID + '">remove</button></div>');
                        }
                        else if (data.success == 1) { alert("Your account must be paired and opted-in in order to add crushes."); }
                        else if (data.success == 2) { alert(ui.item.value + " is already one of your crushes."); }
                        else if (data.success == 3) { alert(ui.item.value + " is not in our database."); }
                        else if (data.success == 4) { alert("You cannot choose yourself as a crush."); }
                        else if (data.success == 5) { alert("Sorry. You can't have more than 5 crushes. Please remove one before adding another."); }
                        else { alert("There was an error in adding your crush. Please try again."); }
                    }, "json");
                return false; // tells autocomplete not to update the field with the selected value
            }
        });
    });

    $("#new-message-form").dialog({
        autoOpen: false,
        height: 400,
        width: 450,
        modal: true,
        buttons: {
            "Send Message": function() {
                                var to = $("input[name='message-to']").val();
                                var name = $("input[name='message-to-box']").val();
                                var body = $("textarea[name='message-body']").val();
                                if (body == "") { alert("Please enter a message body."); return; }
                                $.post("/messages/send", { "to": to, "body": body }, function(data) {
                                    if (data.success == 0) {
                                        $("#new-message-form").dialog("close");
                                        addSentMessage(data.name, body, data.mid);
                                        showMessages('from-me');
                                    }
                                    else if (data.success == 1) { alert("Your account must be paired and opted-in in order to send messages."); }
                                    else if (data.success == 2) { alert(name + " is not in our database. Could not send message."); }
                                    else if (data.success == 3) { alert(name + " is not one of your crushes. You can only send a message to one of your crushes."); }
                                    else if (data.success == 4) { alert("Your message did not have a body. It was not sent."); }
                                    else { alert("There was an error in sending your message. Please try again."); }
                                }, "json");
                            },
            Cancel: function() { $(this).dialog("close"); }
        },
        close: function() { $("textarea[name='message-body']").val(""); }
    });
    
    $(".messageCrush:button").live('click', messageSendListener);
    $(".removeCrush:button").live('click', crushRemoveListener);
    $(".reply-button").live('click', messageReplyListener);
    $(".delete-button").live('click', messageRemoveListener);
    $(".block-button").live('click', blockUserListener);
    $(".reply-text").live('focus', messageSendReplyListener);
});

function addSentMessage(to, body, message_id) {
    var message =
    '<div class="message" data-mid="' + message_id + '">' +
    '  <div class="message-item sent">' +
    '    <div class="message-item-header">' +
    '    <div class="message-item-info"><strong>You</strong> to <strong>' + to + '</strong> just now</div>' +
    '    <div class="message-actions">' +
    '      <ul class="icons ui-widget ui-helper-clearfix">' +
    '        <li class="ui-state-default ui-corner-all reply-button" title="Reply"><span class="ui-icon ui-icon-arrowreturnthick-1-w"></span></li>' +
    '        <li class="ui-state-default ui-corner-all delete-button" title="Delete"><span class="ui-icon ui-icon-trash"></span></li>' +
    '        <li class="ui-state-default ui-corner-all block-button" title="Block User"><span class="ui-icon ui-icon-cancel"></span></li>' +
    '      </ul>' +
    '    </div>' +
    '    </div>' +
	'    <div class="message-item-body">' + body + '</div>' +
	'  </div>' +
	'  <div class="message-item reply reply-box" style="display:none;"><input type="text" class="reply-text"></div>' +
	'</div>';
	if ($("#messages-from-me .messages .message").length > 0) { $("#messages-from-me .messages .message:first").before(message); }
	else { $("#messages-from-me .messages").html(message); }
}

function crushRemoveListener() {
    var crush = $(this);
    $.post("/crushes/remove", { "crush": $(this).val() }, function(data) {
        if (data.success == 0) {
            crush.parent().fadeOut(function() { $(this).remove(); });
        }
        else if (data.success == 1) { alert("Your account must be paired and opted-in in order to remove crushes."); }
        else if (data.success == 2) { alert("Your crush does not exist."); }
        else { alert("Error in deleting crush. Try again."); }
    }, "json");
}

function messageSendListener(user) {
    $("#new-message-form input[name='message-to']").val($(this).val());
    $("#new-message-form input[name='message-to-box']").val($(this).attr("data-first-name") + ' ' + $(this).attr("data-last-name")); // make this their first name and last name
    $("#new-message-form").dialog("open");
}

function messageRemoveListener() {
    if (confirm("Do you really want to delete this message?")) {
        var message = $(this).parent().parent().parent().parent().parent();
        $.post("/messages/delete", { "mid": message.attr("data-mid") }, function(data) {
            if (data.success == 0) { message.fadeOut("fast", function() { message.remove(); }); }
            else if (data.success == 1) { alert("Your account must be paired and opted-in in order to delete messages."); }
            else if (data.success == 2) { alert("Message does not exist or you tried to delete another user's message."); }
            else { alert("Error in deleting message. Try again."); }
        }, "json");
    }
}

function showMessages(tab) {
    $(".messages-tab").hide();
    $("#messages-" + tab).show();
    $("#messages-nav li").removeClass("active");
    $("#messages-nav-" + tab).addClass("active");
}

function messageReplyListener() {
    $(this).parent().parent().parent().parent().next(".reply-box").show();
    //$(this).parent().parent().parent().next(".reply-box").find("input").focus(); // bug here that causes hitting enter to send many replies
}

function messageSendReplyListener() { // clean up vars
  $(this).keyup(function(event) {
    if (event.keyCode == 13) {
      var message_id = $(this).parent().parent().attr("data-mid");
      var body = $(this).val();
      $(this).val("");
      $(this).parent().before('<div class="message-item sent reply"><div class="message-item-header"><div class="message-item-info"><strong>You</strong> just now</div></div><div class="message-item-body">' + body + '</div></div>');
      $.post("/messages/reply", { "mid": message_id, "body": body }, function(data) {
        if (data.success == 0) { }
        else if (data.success == 1) { alert("Your account must be paired and opted-in in order to reply to messages."); }
        else if (data.success == 2) { alert("Message does not exist or you tried to reply another user's message."); }
        else { alert("Error in replying to  message. Try again. The added message will be gone when you refresh the page."); }
      }, "json");
    }
  });
}

function blockUserListener() {
    alert("feature not working now");
}

</script>
{% endblock %}
