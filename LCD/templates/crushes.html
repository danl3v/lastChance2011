{% extends "base.html" %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/stylesheets/jquery/jquery-ui-1.8.12.custom.css" />
<style>
  div#new-message-form label, div#new-message-form input { display:block; }
  div#new-message-form input.text { margin-bottom:12px; width:95%; padding: .4em; }
  div#new-message-form textarea { display: block; width: 95%; height: 4em; }
  div#new-message-form fieldset { padding:0; border:0; margin-top:25px; }
  div#new-message-form h1 { font-size: 1.2em; margin: .6em 0; }
  h2 { display: inline; }
  button { float: right; }
  #new-crush { margin-left: 2em; }
  .crushdiv { float: left; padding: 5px; width: 10em; text-align: center; }
  span#new-crush form, div.crushdiv form, input { display: inline; }
</style>
{% endblock %}

{% block content %}
<div id="main">

<div class="leftcol">
<h2>Crushes</h2>
<span id="new-crush">new crush: <form action="/crushes/add" method="post"><input type="text" class="crush" name="crush"><input type="submit" value="add"></form></span>
{% for name in carls2carls %}
    {% if name %}
    <div class="crushdiv"><img src="https://apps.carleton.edu/stock/ldapimage.php?id={{ name }}" width="100" height="100"><br>{{ name }} <form class="remove-crush-form" action="/crushes/remove" method="post"><input type="hidden" name="crush" value="{{ name }}"><input type="submit" value="remove"></form></div>
    {% endif %}
{% endfor %}

</div>

<div class="rightcol">
    <h2>Messages</h2><button id="new-message-button">New Message</button>
    <ul id="messages">
       {% for message in messages %}
       <li class="message">{{ message.message }} @ {{ message.created }} <span class="actions">[reply] [delete] [block user]</span></li>
       {% endfor %}
    </ul>
</div>

</div>

<div id="new-message-form" title="New Message">
  <form>
  <fieldset>
    <label for="to">To</label>
    <input type="text" name="to" id="to" class="text ui-widget-content ui-corner-all crush" /><!-- maybe take away autocomplete and put in a menu so you can only select crushes-->
    <label for="body">Body</label>
    <textarea name="body" id="body" class="text ui-widget-content ui-corner-all" /></textarea>
  </fieldset>
</form>
</div>

<script type="text/javascript" src="/js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.12.custom.min.js"></script>
<script>
$(document).ready(function() {
    $(".crush").autocomplete({
        source: "/autofill",
        minLength: 1,
        select: function(event, ui) {
            $(this).val(ui.item.uid);
            // make a post request here to add the crush -- then update using ajax
            return false; // tells autocomplete not to update the field with the selected value
        }
    });

    $( "#new-message-form" ).dialog({
        autoOpen: false,
        height: 400,
        width: 450,
        modal: true,
        buttons: {
            Cancel: function() { $( this ).dialog( "close" ); },
            "Send Message": function() {
                                $.post("/messages/send", { "to": $("input[name='to']").val(), "body": $("textarea[name='body']").val() }, function(data) { alert(data); }); // check for success
                                $(this).dialog("close");
                                alert("message sent"); // make an alert on the page using jquery ui stuff
                                window.location.reload() // actually append the message next time if it it so self or just do not allow sending to self. crushes only and cannot crush yourself
                            }
        },
        close: function() { $("#to").val(""); $("#body").val(""); }
    });

    $( "#new-message-button" ).click(function() { $( "#new-message-form" ).dialog( "open" ); });
});

</script>
{% endblock %}
