{% extends "base.html" %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/stylesheets/jquery/jquery-ui-1.8.12.custom.css" />
<style>
  div#new-message-form label, div#new-message-form input { display:block; }
  div#new-message-form select, div#new-message-form textarea { display: block; width: 95%; }
  div#new-message-form fieldset { padding:0; border:0; margin-top:25px; }
  div#new-message-form h1 { font-size: 1.2em; margin: .6em 0; }
  h2 { display: inline; }
  button { float: right; }
  #new-crush { margin-left: 2em; }
  .crushdiv { float: left; padding: 5px; width: 10em; text-align: center; }
  span#new-crush form, div.crushdiv form, input { display: inline; }
  ul#icons {margin: 0; padding: 0;}
  ul#icons li {margin: 2px; position: relative; padding: 4px 0; cursor: pointer; float: left;  list-style: none;}
  ul#icons span.ui-icon {float: left; margin: 0 4px;}
  li.message { clear: both; }
  .timestamp { float: left; }
  .actions { float: right; }
</style>
{% endblock %}

{% block content %}
<div id="main">

<div class="leftcol">
<h2>Crushes</h2>
<span id="new-crush">new crush: <input type="text" class="crush" name="crush"></span>

<div id="crushes">
{% for name in carls2carls %}
  <div class="crushdiv"><img src="https://apps.carleton.edu/stock/ldapimage.php?id={{ name }}" width="100" height="100"><br>{{ name }}<button class="removeCrush" value="{{ name }}">remove</button></div>
{% endfor %}
</div>

</div>

<div class="rightcol">
    <h2>Messages</h2><button id="new-message-button">New Message</button>
    <ul id="messages">
       {% for message in messages %}
       <li class="message">
	 <div class="timestamp">{{ message.created }}</div>
	 <div class="actions">
	   <ul id="icons" class="ui-widget ui-helper-clearfix">
	     <li class="ui-state-default ui-corner-all" title="Reply"><span class="ui-icon ui-icon-arrowreturnthick-1-w"></span></li>
	     <li class="ui-state-default ui-corner-all" title="Delete"><span class="ui-icon ui-icon-trash"></span></li>
	     <li class="ui-state-default ui-corner-all" title="Block User"><span class="ui-icon ui-icon-cancel"></span></li>
	   </ul>
	 </div>
         <br>{{ message.message }}
       </li>
       {% endfor %}
    </ul>
</div>

</div>

<div id="new-message-form" title="New Message">
  <form>
  <fieldset>
    <label for="to">To</label>
    <select name="to" id="to" class="ui-select-menu ui-widget-content ui-corner-all">
    {% for name in carls2carls %}
      <option value="{{ name }}">{{ name }}</option>
    {% endfor %}
    </select>
    <label for="body">Body</label>
    <textarea name="body" id="body" class="text ui-widget-content ui-corner-all"></textarea>
  </fieldset>
</form>
</div>

<script type="text/javascript" src="/js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.12.custom.min.js"></script>
<script>
$(document).ready(function() {
    $(".crush").autocomplete({
        source: "/autofill",
        minLength: 1,
        select: function(event, ui) {
            $(this).val("");
            $.post("/crushes/add", { "crush": ui.item.uid }, function(data) {
                if (data.success == 0) {
                    $("#crushes").append('<div class="crushdiv"><img src="https://apps.carleton.edu/stock/ldapimage.php?id=' + ui.item.uid + '" width="100" height="100"><br>' + ui.item.uid + '<button class="removeCrush" value="' + ui.item.uid + '">remove</button></div>');
                    $("#to").append('<option value="' + ui.item.uid + '">' + ui.item.uid + '</option>');
                    $(".removeCrush:button:last").click(crushRemoveListener);
                }
                else if (data.success == 1) { alert(ui.item.uid + " is already one of your crushes."); }
                else if (data.success == 2) { alert(ui.item.uid + " is not in our database."); }
            }, "json");
            return false; // tells autocomplete not to update the field with the selected value
        }
    });

    $("#new-message-form").dialog({
        autoOpen: false,
        height: 400,
        width: 450,
        modal: true,
        buttons: {
            Cancel: function() { $(this).dialog("close"); },
            "Send Message": function() {
                                $.post("/messages/send", { "to": $("select[name='to']").val(), "body": $("textarea[name='body']").val() }, function(data) {
                                    if (data.success == 0) {
                                        $("#new-message-form").dialog("close");
                                    }
                                    else if (data.success == 1) {
                                        alert("Your account must be paired in order to send messages.");
                                    }
                                }, "json");
                            }
        },
        close: function() { $("#to").val(""); $("#body").val(""); }
    });

    $("#new-message-button").click(function() { $("#new-message-form").dialog("open"); });

    $(".removeCrush:button").click(crushRemoveListener);
});

function crushRemoveListener() {
    $(this).parent().slideUp(function() { $(this).remove(); });
    $('#to option:contains("' + $(this).val() + '")').remove();
    $.post("/crushes/remove", { "crush": $(this).val() });
}

</script>
{% endblock %}
